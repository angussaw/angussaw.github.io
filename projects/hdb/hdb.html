<!DOCTYPE HTML>
<!--
	Read Only by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Read Only by HTML5 UP</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="../../assets/css/main.css" />
	</head>
	<body class="is-preload">

		<!-- Header -->
		<section id="header">
			<header>
				<span class="image avatar"><img src="../../images/avatar.jpg" alt="" /></span>
				<h4 id="home"><a href="../../index.html">Home</a></h4>

			</header>
			<nav id="nav">
				<ul>
					<li><a href="#introduction" class="active">Introduction</a></li>
					<li><a href="#eda">Exploratory Data Analysis</a></li>
					<li><a href="#data_preparation">Data Preparation Pipeline</a></li>
					<li><a href="#training">Training Pipeline</a></li>
					<li><a href="#model_evaluation">Model Evaluation</a></li>
					<li><a href="#feature_importances">Feature Importances</a></li>
					<li><a href="#deployment">Deployment</a></li>
					<li><a href="#future_improvements">Future improvements</a></li>

				</ul>
			</nav>
			<footer>
				<ul class="icons">
					<li><a href="https://www.linkedin.com/in/angussaw/" class="icon brands fa-linkedin"><span class="label">LinkedIn</span></a></li>
				</ul>
			</footer>
		</section>

		<div id="wrapper">

			<!-- Main -->
				<div id="main">

					<!-- One -->
						<section id="introduction">
							<div class="image main" data-position="center">
								<img src="images/stock_img.jpg" alt="" />
							</div>
							<div class="container">
								<header class="major">
									<h3>Estimating and interpreting HDB resale prices via feature engineering and SHAP values</h3>
									<p>Try it on <a href="https://angussaw-hdb-resale-project-test-srcstreamlit-app-demo-u7muix.streamlit.app/">Streamlit</a>!</p>
								</header>
								<h4>Introduction</h4>
                                

								<p>The objective of this project is to develop an end-to-end machine learning pipeline 
                                    to predict HDB resale prices based on existing features of each HDB flat transaction, 
                                    as well as new derived features based on the geographical location of the flat. 
                                    The end-to-end pipeline includes data preparation, feature engineering, model training and evaluation, 
                                    and deployment.</p>

                                <p>For deployment, the model is deployed on a dashboard that users can input flat details 
                                    to generate a predicted resale price. To understand how the predicted resale prices are 
                                    generated by the model during inference, SHAP values are calculated and plotted on the 
                                    dashboard to determine which features contribute the most to the prediction. 
                                    Geographical plots of the flats' vicinity are also generated to provide a visualization 
                                    of the flat's surrounding amenities.</p>

							</div>
						</section>

						<section id="eda">
							<div class="container">
								<h4>Exploratory Data Analysis</h4>
                                <h5>Tools used</h5>
                                <ul>
									<li>Pandas</li>
									<li>Matplotlib</li>
									<li>Seaborn</li>
									<li>Statistical tests</li>
                                    <li>API requests</li>
                                    <li>Web scraping tools (BeautifulSoup)</li>
                                </ul>

                                <p>The HDB resale price data was downloaded from Data.gov.sg, 
                                    containing approximately 120,000 resale transactions from 2015 to 2020. </p>

                                <p>There are a total of 117,527 rows and 11 columns in the dataset. Each row represents a hdb resale transaction, 
                                    and the target variable is the "resale_price" variable. The EDA selection consists of the following main tasks: 
                                </p>
                                <ol type="1">
                                    <li>Perform one-way ANOVA tests on raw categorical features with the target variable to check whether the unique 
                                        categorical values have statistically significant differing mean resale prices (eg towns, flat model, flat type etc...)</li>

                                    <li>Perform Pearson R tests on raw continous features with the target variable to check whether is it statistically 
                                        significant that the distributions between the continous feature and the target feature are uncorrelated.</li>

                                    <li>Identify features and the steps required clean and preprocess them in the data preparation pipeline 
                                        (changing of data types, imputing null values, mapping to new categories, encoding etc...)</li>

                                    <li>Perform webscraping to obtain list of amenities (malls, parks, mrt stations and schools) in Singapore, 
                                        and make API calls to obtain the coordinates of each amenity, which will used to generate new features for each flat. 
                                        Analyze each derived feature's relationship with the target resale price variable.</li>
                                </ol>
                                <p>Here are the highlights of the EDA performed on the dataset. </p>

                                <h5>Overview of raw features EDA</h5>

								<table>
									<tr>
									  <th>No</th>
									  <th>Feature</th>
									  <th>Type</th>
									  <th>Nulls present</th>
									  <th>Comments</th>
									</tr>
									<tr>
									  <td>1</td>
									  <td>Month</td>
									  <td>Object (string)</td>
									  <td>No</td>
									  <td>- In its raw form, need to convert it to datetime and extract out the year and month values</td>
									</tr>
									<tr>
                                        <td>2</td>
                                        <td>Town</td>
                                        <td>Object (string)</td>
                                        <td>No</td>
                                        <td> <p>- significant relationship with target (one-way ANOVA)</p>
                                             <p>- High cardinality (26 unique values) Will need to map to region to reduce cardinality</p></td>
                                    </tr>
									<tr>
                                        <td>3</td>
                                        <td>Flat Type</td>
                                        <td>Object (string)</td>
                                        <td>No</td>
                                        <td> <p>- very little samples with "MULTI-GENERATION" and "1 ROOM", can consider dropping samples</p>
                                             <p>- majority flat type is "4 ROOM" + significant relationship with target (one-way ANOVA)</p></td>
                                    </tr>
									<tr>
                                        <td>4</td>
                                        <td>Block</td>
                                        <td>Object (string)</td>
                                        <td>No</td>
                                        <td>- too many unique values, likely not useful in predicting target variable</td>
                                      </tr>
                                      <tr>
                                        <td>5</td>
                                        <td>Street Name</td>
                                        <td>Object (string)</td>
                                        <td>No</td>
                                        <td>- too many unique values, likely not useful in predicting target variable</td>
                                      </tr>
                                      <tr>
                                        <td>6</td>
                                        <td>Flat Model</td>
                                        <td>Object (string)</td>
                                        <td>No</td>
                                        <td> <p>- majority flat type is "Model A" + significant relationship with target (one-way ANOVA)</p>
                                             <p>- High cardinality (20 unique values) Will need to consolidate common flat models together to reduce cardinality</p></td>
                                    </tr>
                                    <tr>
                                        <td>7</td>
                                        <td>Storey Range</td>
                                        <td>Object (string)</td>
                                        <td>No</td>
                                        <td> <p>- majority storey range is "7 to 9" + significant relationship with target (one-way ANOVA)</p>
                                             <p>- May need to ordinal encode into numerical variable</p></td>
                                    </tr>
                                    <tr>
                                        <td>8</td>
                                        <td>Floor Square Meter</td>
                                        <td>Float</td>
                                        <td>No</td>
                                        <td> <p>- strong positive correlation with target (pearson R)</p>
                                             <p>- mean floor area is 97.4sqm</p></td>
                                    </tr>
                                    <tr>
                                        <td>9</td>
                                        <td>Lease Commence Date</td>
                                        <td>Integer</td>
                                        <td>No</td>
                                        <td> <p>- Could use along with the year value it to calculate lease age, 
                                            which has a negative correlation with target  (pearson R)</p></td>
                                    </tr>
                                    <tr>
                                        <td>10</td>
                                        <td>Remaining Lease</td>
                                        <td>Object (string)</td>
                                        <td>No</td>
                                        <td> <p>- likely correlated with lease age and lease commence date</p>
                                             <p>- data quality is inconsistent (eg 86 years, 86, 86 years 07 months)</p></td>
                                    </tr>
								  </table> 

                                <h5>Overview of generated features EDA</h5>

                                <table>
									<tr>
									  <th>No</th>
									  <th>Feature</th>
									  <th>Type</th>
									  <th>Nulls present</th>
									  <th>Comments</th>
									</tr>
									<tr>
									  <td>1</td>
									  <td>no_of_schools_within_2_km</td>
									  <td>Integer</td>
									  <td>No</td>
									  <td> <p>- slight negative (-) correlation with the resale value of the flat</p>
                                           <p>- mean number of schools within 2km radius is about 15</p></td>
									</tr>
									<tr>
                                        <td>2</td>
                                        <td>distance_to_nearest_school</td>
                                        <td>Float</td>
                                        <td>No</td>
                                        <td> <p>- slight positive (+) correlation with the resale value of the flat</p>
                                             <p>- mean distance to the nearest school is about 300m</p></td>
                                    </tr>
                                    <tr>
                                        <td>3</td>
                                        <td>no_of_mrt_stations_within_2_km</td>
                                        <td>Integer</td>
                                        <td>No</td>
                                        <td> <p>- slight postive (+) correlation with the resale value of the flat</p>
                                             <p>- mean number of mrt stations within 2km radius is about 3</p></td>
                                    </tr>
									<tr>
                                        <td>4</td>
                                        <td>distance_to_nearest_mrt_station</td>
                                        <td>Float</td>
                                        <td>No</td>
                                        <td> <p>- slight negative (-) correlation with the resale value of the flat</p>
                                             <p>- mean distance to the nearest mrt station is about 855m</p></td>
                                    </tr>
                                    <tr>
                                        <td>5</td>
                                        <td>no_of_malls_within_2_km</td>
                                        <td>Integer</td>
                                        <td>No</td>
                                        <td> <p>- slight postive (+) correlation with the resale value of the flat</p>
                                             <p>- mean number of malls within 2km radius is about 5</p></td>
                                    </tr>
									<tr>
                                        <td>6</td>
                                        <td>distance_to_nearest_mall</td>
                                        <td>Float</td>
                                        <td>No</td>
                                        <td> <p>- slight negative (-) correlation with the resale value of the flat</p>
                                             <p>- mean distance to the nearest mall is about 665m</p></td>
                                    </tr>
                                    <tr>
                                        <td>7</td>
                                        <td>no_of_parks_within_2_km</td>
                                        <td>Integer</td>
                                        <td>No</td>
                                        <td> <p>- slight postive (+) correlation with the resale value of the flat</p>
                                             <p>- mean number of parks within 2km radius is almost 2</p></td>
                                    </tr>
									<tr>
                                        <td>8</td>
                                        <td>distance_to_nearest_park</td>
                                        <td>Float</td>
                                        <td>No</td>
                                        <td> <p>- slight negative (-) correlation with the resale value of the flat</p>
                                             <p>- mean distance to the nearest park is about 1.2km</p></td>
                                    </tr>
                                </table>
							</div>
						</section>	

						<section id="data_preparation">
							<div class="container">
								<h4>Data Preparation Pipeline</h4>
                                <h5>Tools used</h5>
                                <ul>
									<li>Pandas</li>
									<li>Geopy</li>
									<li>Docker</li>
									<li>Postgres SQL</li>
                                </ul>
								<p>The raw data is first read from the filepath and passed through the Data Cleaning module. 
                                    The cleaned data is then passed through the Feature Engineering module, 
                                    which generates derived features based on existing raw features as well as the coordinates of the various amenities. 
                                    The derived features are then saved to a datatable in a Postgres database for storage.</p>

                                <a class="image"><img src="images/data_preparation_pipeline.png" width="800" height="350"/></a>

							</div>
						</section>	

						<section id="training">
							<div class="container">
								<h4>Training Pipeline</h4>
                                <h5>Tools used</h5>
                                <ul>
									<li>Scikit-learn</li>
                                    <li>MlFlow</li>
									<li>Hydra</li>
									<li>Hyperparameter tuning (Optuna)</li>
									<li>Docker</li>
                                </ul>
								<p>The derived features and target variable are first extracted from Postgres. 
                                    The derived features then undergo a series of preprocessing steps that include ordinal encoding, one-hot encoding, 
                                    train-validation-test splitting and standard scaling if necessary. </p>

                                <p>The model is initialized with its specified hyperparameters and then trained on the training data. 
                                    The trained model is then evaluated on the various datasets using an Evaluator class, 
                                    generating visualizations and performance metrics. </p>

                                <p>The model and its respective set of parameters, visualizations and metrics are then logged to MLFLow for tracking.
                                    Lastly, the metric to optimize the model on is returned at the end of the train pipeline.</p>

                                <a class="image"><img src="images/train_pipeline.png" width="800" height="300"/></a>

							</div>
						</section>	

						<section id="model_evaluation">
							<div class="container">
								<h4>Model Evaluation</h4>

								<p>The following model architectures using ensemble learning (combining multiple weak learners 
                                    into one predictive model) are trained:</p>
                                
                                <ul>
                                    <li>Random Forest</li>
                                    <li>Explainable Boosting Regressor</li>
                                    <li>XGBoost</li>
                                </ul>

                                <p>For each model architecture, a baseline model is trained using all derived features and the default hyperparameters. 
                                    The model's hyperparameters are then fine-tuned using Optuna to search for the optimal set of hyperparameters 
                                    that minimizes the specified performance metric (validation room mean squared error). </p>

                                <p>The model and its respective set of parameters, visualizations and metrics are then logged to MLFLow for tracking.
                                    Lastly, the metric to optimize the model on is returned at the end of the train pipeline.</p>

                                <table>
                                    <tr>
                                        <th>Model</th>
                                        <th>Baseline Train RMSE</th>
                                        <th>Baseline Validation RMSE</th>
                                        <th>Fine-tuned Train RMSE</th>
                                        <th>Fine-tuned Validation RMSE</th>
                                        <th>Baseline Train R Squared</th>
                                        <th>Baseline Validation R Squared</th>
                                        <th>Fine-tuned Train R Squared</th>
                                        <th>Fine-tuned Validation R Squared</th>
                                        <th>Fine-tuned Parameters</th>
                                    </tr>
                                    <tr>
                                        <td>Random Forest</td>
                                        <td>69247.1</td>
                                        <td>68800.6</td>
                                        <td>13282.7</td>
                                        <td>26525.8</td>
                                        <td>0.771</td>
                                        <td>0.77</td>
                                        <td>0.992</td>
                                        <td>0.966</td>
                                        <td><p>max_depth:20, 
                                            min_samples_leaf:1, 
                                            n_estimators:205</p></td>
                                    </tr>
                                    <tr>
                                        <td>Explainable Boosting Regressor</td>
                                        <td>55222.2</td>
                                        <td>55435.6</td>
                                        <td>45915.1</td>
                                        <td>46890.1</td>
                                        <td>0.855</td>
                                        <td>0.85</td>
                                        <td>0.899</td>
                                        <td>0.893</td>
                                        <td><p></p>inner_bags:0, 
                                            interactions:10, 
                                            learning_rate:0.01, 
                                            max_bins:256, 
                                            max_interaction_bins:32, 
                                            max_leaves:3, 
                                            min_samples_leaf:2, 
                                            outer_bags:8,</p></td>
                                    </tr>
                                    <tr>
                                        <td>XGBoost</td>
                                        <td>25637.9</td>
                                        <td>29166.1</td>
                                        <td>16657.6</td>
                                        <td>25119.7</td>
                                        <td>0.969</td>
                                        <td>0.959</td>
                                        <td>0.987</td>
                                        <td>0.969</td>
                                        <td><p>max_depth:8, 
                                            learning_rate:0.1, 
                                            n_estimators:480</p></td>
                                    </tr>
                                </table>

                                <p>For the baseline models, XGBoost has the lowest validation root mean squared error of 29116, 
                                    and the highest validation R squared score of 0.959. There is not much overfitting on the training set, 
                                    as observed by the minor differences between the train and validation scores. </p>

                                <p>After fine tuning the hyperparameters to minimize the validation root mean squared error using the Optuna's TPE sampler, 
                                    the XGBoost model's validation root mean squared error and R squared score decreased and increased to 25119 and 0.969 
                                    respectively. The fine-tuned XGBoost model was using a learning rate of 0.1 (default: 0.3), 
                                    maximmum depth of 8 (default: 6) and 480 estimators (default: 100). </p>

                                <p>The fine-tuned random forest model's validation root mean squared error and R squared score decreased and increased 
                                    to 26525 and 0.966 respectively. It uses a max depth of 20, and 205 estimators (default: 100)</p>
                                
                                <p>The selected models are also evaluated on the test set to ensure that the model is able estimate accurate predictions on new unseen data</p>

                                <table>
                                    <tr>
                                        <th>Model</th>
                                        <th>Test RMSE</th>
                                        <th>Test R Squared</th>
                                    </tr>
                                    <tr>
                                        <td>Random Forest</td>
                                        <td>25936.6</td>
                                        <td>0.968</td>
                                    </tr>
                                    <tr>
                                        <td>Random Forest</td>
                                        <td>24751.4</td>
                                        <td>0.971</td>
                                    </tr>
                                </table>
							</div>
						</section>	

						<section id="feature_importances">
							<div class="container">
								<h4>Feature Importances</h4>

								<p>SHAP values were calculated using the training set feature values, and were used to generate a summary plot to visualize 
                                    which features have the greatest contribution to the final model prediction</p>
                                
                                <a class="image"><img src="images/xgboost_plots.png" width="800" height="300"/></a>

                                <p>Based on the summary plot for the XGBoost model, the top 5 features that have the highest SHAP values across all samples 
                                    are "floor_area_sqm", "lease_age", "region_Central", "distance_to_nearest_MRT_stations" and "storey_range".</p>

                                <table>
                                    <tr>
                                        <th>Feature</th>
                                        <th>Contribution</th>
                                    </tr>
                                    <tr>
                                        <td>floor_area_sqm</td>
                                        <td>The larger the floor area of a flat, the greater its contribution in 
                                            increasing its predicted resale price, and vice versa</td>
                                    </tr>
                                    <tr>
                                        <td>lease_age</td>
                                        <td>The older the flat, the greater its contribution in decreasing its predicted 
                                            resale price, and vice versa</td>
                                    </tr>
                                    <tr>
                                        <td>region_Central</td>
                                        <td>If a flat is located in the central region, it increases 
                                            the predicted resale price, and vice versa</td>
                                    </tr>
                                    <tr>
                                        <td>distance_to_nearest_MRT_stations</td>
                                        <td>The closer the nearest MRT station is to a flat, the greater its 
                                            contribution in increasing its predicted resale price, and vice versa</td>
                                    </tr>
                                    <tr>
                                        <td>storey_range</td>
                                        <td>The higher the flat is, the greater its contribution in increasing 
                                            its predicted resale price, and vice versa</td>
                                    </tr>
                                </table>

							</div>
						</section>	

						<section id="deployment">
							<div class="container">
								<h4>Deployment</h4>
                                <h5>Tools used</h5>
                                <ul>
                                    <li>Streamlit</li>
									<li>Folium</li>
									<li>FastAPI</li>
									<li>Docker</li>
                                </ul>
								<p>Between the various ensemble models that were trained, XGBoost model is selected for deployment as 
                                    it has the best performance on the train and validation sets. 
                                    It is also the fastest model to train out of the three models, 
                                    which in turn takes the shortest time to generate the SHAP explainer for it. 
                                    (With 20 features used, approximately 2^20 models are trained to generate the SHAP explainer)</p>

                                <p>The deployment is separated into two main components: </p> 
                                
                                <ol type="1">
                                    <li>The frontend where the user will interact with the dashboard by 
                                        inputing flat details and view the visualizations generated</li>
                                    <li>The backend where the pipelines for data preparation, 
                                        model prediction and SHAP values calculation will be performed</li>
                                </ol>
                                    
                                <p>A Streamlit dashboard is built for the frontend, which will post requests to the backend via FastAPI 
                                    to trigger the relevant pipelines whenever a user submits flat details to estimate its resale price.</p>

                                <a class="image"><img src="images/streamlit_fastapi.png" width="800" height="350"/></a>

                                <ol type="1">
                                    <li><u>Validation of input data</u>: This ensures that the flat details submitted by the user is valid and 
                                        suitable for model prediction (eg lease commence year cannot be older than transaction year)</li>
                                    <li><u>Post request to backend to perform data prep</u>: A request is sent to the backend to clean the input data 
                                        and generate new derived features from it. It returns a dataframe consisting of derived features to the frontend 
                                        where it will be displayed (eg distances to nearest amenities, number of nearby amenities)</li>
                                    <li><u>Post request to backend to predict resale value</u>: Another request is sent to the backend to predict 
                                        the resale value of a flat. If required, the data is encoded/scaled using the encoder/scaler object that was 
                                        fitted on the training data. After which, the data is fed to the model to estimate the resale price. 
                                        The model and the encoder/scaler objects are retrieved as artifacts from the respective MLFlow run</li>
                                    <li><u>Render map showing the hdb flat surroundings and nearby amenities</u>: Using the derived features, 
                                        a geographical map is rendered on the dashboard displaying the names and locations of the nearest amenities 
                                        that are within the flat's radius</li>
                                    <li><u>Post request to backend to generate shap values</u>: Another request is sent to the backend to calculate the 
                                        SHAP values for the flat's derived features. It returns a SHAP explainer object back to the frontend</li>
                                    <li><u>Render waterfall plot of shap values to explain model prediction</u>: Using the SHAP explainer object, 
                                        a waterfall plot is rendered on the dashboard to display the contributions that each feature value of the 
                                        flat made to the final predicted resale price.</li>
                                </ol>
                                    
                                <a class="image"><img src="images/dashboard_screenshot.png" width="800" height="400"/></a>

							</div>
						</section>	

						<section id="future_improvements">
							<div class="container">
								<h4>Future Improvements</h4>
                                <ol type="1">
									<li>As time goes by, with the construction of new mrt stations and malls, the amenity details needs to be updated 
                                        to ensure that the derived features are accurate.</li>
									<li>For now, the opening date for the amenities is only accounted for MRT stations. 
                                        Accounting the opening date for the other amenties would ensure that the derived features are more accurate.</li>
									<li>New amenities that could possibly affect resale prices can be included in the feature engineering pipeline 
                                        (eg medical centers, food centres, bus stops, interchanges etc)</li>
									<li>Another round of feature selection can be performed by removing some features that have strong correlation 
                                        with each other, as this might confound the model's explainability.</li>
                                    <li>The target variable can be transformed by factoring in the yearly consumer price index before training to ensure 
                                        that the model's predictions reflect the current economic conditions in Singapore</li>
                                </ol>
							</div>
						</section>	

                        <section id="footer">
                            <div class="container">
                                <ul class="copyright">
                                    <li>&copy; Untitled. All rights reserved.</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
                                </ul>
                            </div>
                        </section>
    
                </div>
    
            <!-- Scripts -->
                <script src="assets/js/jquery.min.js"></script>
                <script src="assets/js/jquery.scrollex.min.js"></script>
                <script src="assets/js/jquery.scrolly.min.js"></script>
                <script src="assets/js/browser.min.js"></script>
                <script src="assets/js/breakpoints.min.js"></script>
                <script src="assets/js/util.js"></script>
                <script src="assets/js/main.js"></script>
    
        </body>
    </html>